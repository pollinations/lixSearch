# Nginx Configuration for lixSearch
# 
# Features:
# - Load balancing across lixsearch-app containers
# - Rate limiting
# - Request logging with session IDs
# - Health check endpoint
# - Caching of responses
# - Security headers
# - Proxy timeout settings for streaming endpoints

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
  worker_connections 4096;
  use epoll;
  multi_accept on;
}

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  # ========================================================================
  # LOGGING
  # ========================================================================
  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"';

  log_format detailed '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent '
                      '"$http_x_session_id" "$http_x_request_id" '
                      '$request_time $upstream_response_time '
                      '"$http_user_agent"';

  access_log /var/log/nginx/access.log main;

  # ========================================================================
  # PERFORMANCE
  # ========================================================================
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;
  types_hash_max_size 2048;
  client_max_body_size 100M;

  # Buffer sizes
  client_body_buffer_size 128k;
  client_header_buffer_size 1k;
  large_client_header_buffers 4 16k;

  # Gzip compression
  gzip on;
  gzip_vary on;
  gzip_comp_level 6;
  gzip_types text/plain text/css text/xml text/javascript 
             application/json application/javascript application/xml+rss 
             application/rss+xml font/truetype font/opentype 
             application/vnd.ms-fontobject image/svg+xml;

  # ========================================================================
  # RATE LIMITING
  # ========================================================================
  # Limit requests per IP: 100 requests per 10 seconds
  limit_req_zone $binary_remote_addr zone=general:10m rate=100r/s;
  
  # Stricter limit for search endpoints: 50 req per 10s
  limit_req_zone $binary_remote_addr zone=search:10m rate=50r/s;
  
  # Stricter limit for chat endpoints: 30 req per 10s
  limit_req_zone $binary_remote_addr zone=chat:10m rate=30r/s;

  # ========================================================================
  # UPSTREAM: lixsearch app containers
  # ========================================================================
  # When scaling: docker-compose -f docker-compose.prod.yml up --scale lixsearch-app=3
  # Nginx will auto-discover containers via service name 'lixsearch-app'
  upstream lixsearch_backend {
    # Health check: remove unhealthy servers
    check interval=3000 rise=2 fall=5 timeout=1000 type=http;
    check_http_send "GET /api/health HTTP/1.0\r\n\r\n";
    check_http_expect_alive http_2xx;

    # Load balancing: least connections (best for long-lived connections)
    least_conn;

    # Service discovery (Docker DNS resolves to all lixsearch-app instances)
    server lixsearch-app:8000 max_fails=3 fail_timeout=10s;
  }

  # ========================================================================
  # CACHING
  # ========================================================================
  proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=lixsearch_cache:100m 
                   max_size=1g inactive=60m use_temp_path=off;

  # Cache status for debugging
  map $upstream_cache_status $cache_status {
    MISS "MISS";
    HIT "HIT";
    STALE "STALE";
    BYPASS "BYPASS";
    default $upstream_cache_status;
  }

  # ========================================================================
  # SSL/TLS Configuration (disabled for HTTP, enable for HTTPS)
  # ========================================================================
  # To enable SSL:
  # 1. Place certificates in ./ssl/
  # 2. Update server block with:
  #    - listen 443 ssl http2;
  #    - ssl_certificate /etc/nginx/ssl/cert.pem;
  #    - ssl_certificate_key /etc/nginx/ssl/key.pem;
  #    - Redirect HTTP to HTTPS

  # ========================================================================
  # MAIN SERVER BLOCK
  # ========================================================================
  server {
    listen 80;
    server_name _;

    # Health check endpoint (for docker healthcheck)
    location /api/health {
      access_log off;
      proxy_pass http://lixsearch_backend;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_connect_timeout 5s;
      proxy_read_timeout 10s;
    }

    # =====================================================================
    # SEARCH ENDPOINT (/api/search)
    # =====================================================================
    location /api/search {
      limit_req zone=search burst=10 nodelay;

      # Upstream request
      proxy_pass http://lixsearch_backend;

      # HTTP version and keep-alive
      proxy_http_version 1.1;
      proxy_set_header Connection "";

      # Pass headers from client
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Request-ID $http_x_request_id;
      proxy_set_header X-Session-ID $http_x_session_id;

      # Timeouts (important for long-running searches)
      proxy_connect_timeout 10s;
      proxy_send_timeout 120s;
      proxy_read_timeout 300s;  # 5 minutes for streaming responses

      # Buffering (disable for streaming SSE)
      proxy_buffering off;
      proxy_request_buffering off;

      # Cache settings (disable caching for search, as results are dynamic)
      proxy_cache off;

      # Errors
      proxy_intercept_errors off;
    }

    # =====================================================================
    # CHAT ENDPOINTS (/api/chat, /api/session/<id>/chat)
    # =====================================================================
    location ~ ^/api/(session/)?chat {
      limit_req zone=chat burst=5 nodelay;

      proxy_pass http://lixsearch_backend;

      proxy_http_version 1.1;
      proxy_set_header Connection "";

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Request-ID $http_x_request_id;
      proxy_set_header X-Session-ID $http_x_session_id;

      # Timeouts for chat (streaming responses)
      proxy_connect_timeout 10s;
      proxy_send_timeout 120s;
      proxy_read_timeout 300s;

      # Disable buffering for SSE
      proxy_buffering off;
      proxy_request_buffering off;

      # No caching
      proxy_cache off;
      proxy_intercept_errors off;
    }

    # =====================================================================
    # SESSION ENDPOINTS (/api/session/<id>/...)
    # =====================================================================
    location ~ ^/api/session/[^/]+/ {
      limit_req zone=general burst=20 nodelay;

      proxy_pass http://lixsearch_backend;

      proxy_http_version 1.1;
      proxy_set_header Connection "";

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Request-ID $http_x_request_id;
      proxy_set_header X-Session-ID $http_x_session_id;

      # Standard timeouts
      proxy_connect_timeout 10s;
      proxy_send_timeout 30s;
      proxy_read_timeout 60s;

      # Enable buffering for non-streaming endpoints
      proxy_buffering on;
      proxy_buffer_size 4k;
      proxy_buffers 8 4k;

      # No caching for session data (always fresh)
      proxy_cache off;
      proxy_intercept_errors off;
    }

    # =====================================================================
    # STATS ENDPOINT (/api/stats)
    # =====================================================================
    location /api/stats {
      proxy_pass http://lixsearch_backend;

      proxy_http_version 1.1;
      proxy_set_header Connection "";

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_connect_timeout 5s;
      proxy_send_timeout 10s;
      proxy_read_timeout 30s;

      # Cache stats for 10 seconds
      proxy_cache lixsearch_cache;
      proxy_cache_valid 200 10s;
      proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;

      add_header X-Cache-Status $cache_status;
    }

    # =====================================================================
    # WEBSOCKET ENDPOINT (/ws/search)
    # =====================================================================
    location /ws/search {
      proxy_pass http://lixsearch_backend;

      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # WebSocket timeouts (keep-alive connections)
      proxy_connect_timeout 10s;
      proxy_send_timeout 3600s;
      proxy_read_timeout 3600s;

      # No buffering for WebSocket
      proxy_buffering off;
    }

    # =====================================================================
    # FALLBACK: All other requests
    # =====================================================================
    location / {
      limit_req zone=general burst=20 nodelay;

      proxy_pass http://lixsearch_backend;

      proxy_http_version 1.1;
      proxy_set_header Connection "";

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Request-ID $http_x_request_id;

      proxy_connect_timeout 10s;
      proxy_send_timeout 30s;
      proxy_read_timeout 60s;

      proxy_buffering on;
      proxy_buffer_size 4k;
      proxy_buffers 8 4k;

      proxy_cache off;
    }

    # =====================================================================
    # ERROR PAGES
    # =====================================================================
    error_page 502 503 504 /50x.html;
    location = /50x.html {
      default_type text/html;
      return 503 '{"error": "Service unavailable", "status": 503}';
    }

    error_page 504 /504.html;
    location = /504.html {
      default_type text/html;
      return 504 '{"error": "Gateway timeout", "status": 504}';
    }
  }
}
