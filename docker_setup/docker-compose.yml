services:
  # Chroma Vector Database Server
  # Dedicated server for efficient vector operations
  # Eliminates bottleneck of embedded Chroma by supporting concurrent access
  chroma-server:
    image: chromadb/chroma:latest
    container_name: chroma-server
    ports:
      - "8100:8000"
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma_data
      - ANONYMIZED_TELEMETRY=FALSE
      - CHROMA_LOG_LEVEL=INFO
    volumes:
      - ../data/embeddings/chroma_data:/chroma_data
    networks:
      - elixpo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  
  # Load Balancer - Single instance on port 8000
  # Routes requests to 10 worker instances (8001-8010) using round-robin
  elixpo-search-lb:
    build: .
    container_name: elixpo-search-lb
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - APP_MODE=load_balancer
      - CHROMA_API_IMPL=http
      - CHROMA_SERVER_HOST=chroma-server
      - CHROMA_SERVER_PORT=8000
    volumes:
      - ./logs:/app/logs
      - ../data/embeddings:/app/data/embeddings
      - ../data/cache:/app/data/cache
    depends_on:
      chroma-server:
        condition: service_healthy
      elixpo-search-worker-1:
        condition: service_healthy
      elixpo-search-worker-2:
        condition: service_healthy
      elixpo-search-worker-3:
        condition: service_healthy
      elixpo-search-worker-4:
        condition: service_healthy
      elixpo-search-worker-5:
        condition: service_healthy
      elixpo-search-worker-6:
        condition: service_healthy
      elixpo-search-worker-7:
        condition: service_healthy
      elixpo-search-worker-8:
        condition: service_healthy
      elixpo-search-worker-9:
        condition: service_healthy
      elixpo-search-worker-10:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - elixpo-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 40s
      retries: 3
      start_period: 60s

  # Worker 1 - Port 8001
  elixpo-search-worker-1:
    build: .
    container_name: elixpo-search-worker-1
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - APP_MODE=worker
      - WORKER_ID=1
      - WORKER_PORT=8001
      - CHROMA_API_IMPL=http
      - CHROMA_SERVER_HOST=chroma-server
      - CHROMA_SERVER_PORT=8000
    volumes:
      - ./logs:/app/logs
      - ../data/embeddings:/app/data/embeddings
      - ../data/cache:/app/data/cache
    restart: unless-stopped
    networks:
      - elixpo-network
    expose:
      - "8001"
    depends_on:
      chroma-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 40s
      retries: 3
      start_period: 60s

  # Worker 2 - Port 8002
  elixpo-search-worker-2:
    build: .
    container_name: elixpo-search-worker-2
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - APP_MODE=worker
      - WORKER_ID=2
      - WORKER_PORT=8002
      - CHROMA_API_IMPL=http
      - CHROMA_SERVER_HOST=chroma-server
      - CHROMA_SERVER_PORT=8000
    volumes:
      - ./logs:/app/logs
      - ../data/embeddings:/app/data/embeddings
      - ../data/cache:/app/data/cache
    restart: unless-stopped
    networks:
      - elixpo-network
    expose:
      - "8002"
    depends_on:
      chroma-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/api/health"]
      interval: 30s
      timeout: 40s
      retries: 3
      start_period: 60s

  # Worker 3 - Port 8003
  elixpo-search-worker-3:
    build: .
    container_name: elixpo-search-worker-3
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - APP_MODE=worker
      - WORKER_ID=3
      - WORKER_PORT=8003
      - CHROMA_API_IMPL=http
      - CHROMA_SERVER_HOST=chroma-server
      - CHROMA_SERVER_PORT=8000
    volumes:
      - ./logs:/app/logs
      - ../data/embeddings:/app/data/embeddings
      - ../data/cache:/app/data/cache
    restart: unless-stopped
    networks:
      - elixpo-network
    expose:
      - "8003"
    depends_on:
      chroma-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/api/health"]
      interval: 30s
      timeout: 40s
      retries: 3
      start_period: 60s

  # Worker 4 - Port 8004
  elixpo-search-worker-4:
    build: .
    container_name: elixpo-search-worker-4
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - APP_MODE=worker
      - WORKER_ID=4
      - WORKER_PORT=8004
      - CHROMA_API_IMPL=http
      - CHROMA_SERVER_HOST=chroma-server
      - CHROMA_SERVER_PORT=8000
    volumes:
      - ./logs:/app/logs
      - ../data/embeddings:/app/data/embeddings
      - ../data/cache:/app/data/cache
    restart: unless-stopped
    networks:
      - elixpo-network
    expose:
      - "8004"
    depends_on:
      chroma-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/api/health"]
      interval: 30s
      timeout: 40s
      retries: 3
      start_period: 60s

  # Worker 5 - Port 8005
  elixpo-search-worker-5:
    build: .
    container_name: elixpo-search-worker-5
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - APP_MODE=worker
      - WORKER_ID=5
      - WORKER_PORT=8005
      - CHROMA_API_IMPL=http
      - CHROMA_SERVER_HOST=chroma-server
      - CHROMA_SERVER_PORT=8000
    volumes:
      - ./logs:/app/logs
      - ../data/embeddings:/app/data/embeddings
      - ../data/cache:/app/data/cache
    restart: unless-stopped
    networks:
      - elixpo-network
    expose:
      - "8005"
    depends_on:
      chroma-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/api/health"]
      interval: 30s
      timeout: 40s
      retries: 3
      start_period: 60s

  # Worker 6 - Port 8006
  elixpo-search-worker-6:
    build: .
    container_name: elixpo-search-worker-6
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - APP_MODE=worker
      - WORKER_ID=6
      - WORKER_PORT=8006
      - CHROMA_API_IMPL=http
      - CHROMA_SERVER_HOST=chroma-server
      - CHROMA_SERVER_PORT=8000
    volumes:
      - ./logs:/app/logs
      - ../data/embeddings:/app/data/embeddings
      - ../data/cache:/app/data/cache
    restart: unless-stopped
    networks:
      - elixpo-network
    expose:
      - "8006"
    depends_on:
      chroma-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/api/health"]
      interval: 30s
      timeout: 40s
      retries: 3
      start_period: 60s

  # Worker 7 - Port 8007
  elixpo-search-worker-7:
    build: .
    container_name: elixpo-search-worker-7
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - APP_MODE=worker
      - WORKER_ID=7
      - WORKER_PORT=8007
      - CHROMA_API_IMPL=http
      - CHROMA_SERVER_HOST=chroma-server
      - CHROMA_SERVER_PORT=8000
    volumes:
      - ./logs:/app/logs
      - ../data/embeddings:/app/data/embeddings
      - ../data/cache:/app/data/cache
    restart: unless-stopped
    networks:
      - elixpo-network
    expose:
      - "8007"
    depends_on:
      chroma-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8007/api/health"]
      interval: 30s
      timeout: 40s
      retries: 3
      start_period: 60s

  # Worker 8 - Port 8008
  elixpo-search-worker-8:
    build: .
    container_name: elixpo-search-worker-8
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - APP_MODE=worker
      - WORKER_ID=8
      - WORKER_PORT=8008
      - CHROMA_API_IMPL=http
      - CHROMA_SERVER_HOST=chroma-server
      - CHROMA_SERVER_PORT=8000
    volumes:
      - ./logs:/app/logs
      - ../data/embeddings:/app/data/embeddings
      - ../data/cache:/app/data/cache
    restart: unless-stopped
    networks:
      - elixpo-network
    expose:
      - "8008"
    depends_on:
      chroma-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8008/api/health"]
      interval: 30s
      timeout: 40s
      retries: 3
      start_period: 60s

  # Worker 9 - Port 8009
  elixpo-search-worker-9:
    build: .
    container_name: elixpo-search-worker-9
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - APP_MODE=worker
      - WORKER_ID=9
      - WORKER_PORT=8009
      - CHROMA_API_IMPL=http
      - CHROMA_SERVER_HOST=chroma-server
      - CHROMA_SERVER_PORT=8000
    volumes:
      - ./logs:/app/logs
      - ../data/embeddings:/app/data/embeddings
      - ../data/cache:/app/data/cache
    restart: unless-stopped
    networks:
      - elixpo-network
    expose:
      - "8009"
    depends_on:
      chroma-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8009/api/health"]
      interval: 30s
      timeout: 40s
      retries: 3
      start_period: 60s

  # Worker 10 - Port 8010
  elixpo-search-worker-10:
    build: .
    container_name: elixpo-search-worker-10
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - APP_MODE=worker
      - WORKER_ID=10
      - WORKER_PORT=8010
      - CHROMA_API_IMPL=http
      - CHROMA_SERVER_HOST=chroma-server
      - CHROMA_SERVER_PORT=8000
    volumes:
      - ./logs:/app/logs
      - ../data/embeddings:/app/data/embeddings
      - ../data/cache:/app/data/cache
    restart: unless-stopped
    networks:
      - elixpo-network
    expose:
      - "8010"
    depends_on:
      chroma-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/api/health"]
      interval: 30s
      timeout: 40s
      retries: 3
      start_period: 60s

networks:
  elixpo-network:
    driver: bridge